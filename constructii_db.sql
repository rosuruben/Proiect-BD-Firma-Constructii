/* ==================================================
   1. CREAREA TABELELOR ȘI A CONSTRÂNGERILOR DE BAZĂ
   ================================================== */

-- Tabel CLIENT
CREATE TABLE CLIENT (
    ID_CLIENT NUMBER(5) PRIMARY KEY,
    NUME VARCHAR2(20) NOT NULL,
    PRENUME VARCHAR2(30) NOT NULL,
    ADRESA VARCHAR2(50) NOT NULL,
    ORAS VARCHAR2(20) NOT NULL,
    COD_POSTAL VARCHAR2(6) NOT NULL,
    NR_TELEFON VARCHAR2(10) NOT NULL
);

-- Tabel PROIECT
CREATE TABLE PROIECT(
    ID_PROIECT NUMBER(5) PRIMARY KEY,
    ID_CLIENT NUMBER(5) NOT NULL,
    STATUS VARCHAR2(20) NOT NULL,
    DATA_INCEPERE DATE NOT NULL,
    DATA_FINALIZARE DATE,
    CONSTRAINT FK_PROIECT_CLIENT FOREIGN KEY(ID_CLIENT) REFERENCES CLIENT(ID_CLIENT)
);

-- Tabel ANGAJAT
CREATE TABLE ANGAJAT(
    ID_ANGAJAT NUMBER(5) PRIMARY KEY,
    NUME VARCHAR2(20) NOT NULL,
    PRENUME VARCHAR2(30) NOT NULL,
    DATA_NASTERII DATE NOT NULL,
    DATA_ANGAJARII DATE NOT NULL,
    SALARIU NUMBER(5) NOT NULL,
    CALIFICARE VARCHAR2(20),
    SPECIALIZARE VARCHAR2(20)
);

-- Tabel ALOCARE_MUNCITORI (Tabel de legătură M:N)
CREATE TABLE ALOCARE_MUNCITORI(
    ID_ALOCARE_MUNCITOR NUMBER(5) PRIMARY KEY,
    ID_PROIECT NUMBER(5) NOT NULL,
    ID_ANGAJAT NUMBER(5) NOT NULL,
    NR_ORE_LUCRATE NUMBER(4) NOT NULL,
    CONSTRAINT FK_ALOCARE1_PROIECT FOREIGN KEY(ID_PROIECT) REFERENCES PROIECT(ID_PROIECT),
    CONSTRAINT FK_ALOCARE_ANGAJAT FOREIGN KEY(ID_ANGAJAT) REFERENCES ANGAJAT(ID_ANGAJAT)
);

-- Tabel FURNIZOR
CREATE TABLE FURNIZOR(
    ID_FURNIZOR NUMBER(5) PRIMARY KEY,
    DENUMIRE_FIRMA VARCHAR2(30) NOT NULL,
    ADRESA VARCHAR2(30) NOT NULL,
    ORAS VARCHAR2(30) NOT NULL,
    COD_POSTAL VARCHAR2(6) NOT NULL,
    NR_TELEFON VARCHAR2(10) NOT NULL
);

-- Tabel MATERIALE
CREATE TABLE MATERIALE(
    ID_MATERIAL NUMBER(5) PRIMARY KEY,
    ID_FURNIZOR NUMBER(5) NOT NULL,
    DESCRIERE VARCHAR2(30) NOT NULL,
    COST NUMBER(6) NOT NULL,
    CONSTRAINT FK_MATERIAL_FURNIZOR FOREIGN KEY(ID_FURNIZOR) REFERENCES FURNIZOR(ID_FURNIZOR)
);

-- Tabel ALOCARI_MATERIALE (Tabel de legătură M:N)
CREATE TABLE ALOCARI_MATERIALE(
    ID_ALOCARE_MATERIAL NUMBER(5),
    ID_PROIECT NUMBER(5) NOT NULL,
    ID_MATERIAL NUMBER(5) NOT NULL,
    CANTITATE NUMBER(5) NOT NULL,
    CONSTRAINT FK_ALOCARE2_PROIECT FOREIGN KEY(ID_PROIECT) REFERENCES PROIECT(ID_PROIECT),
    CONSTRAINT FK_ALOCARE_MATERIAL FOREIGN KEY(ID_MATERIAL) REFERENCES MATERIALE(ID_MATERIAL)
);

/* ==================================================
   2. ADĂUGAREA CONSTRÂNGERILOR SUPLIMENTARE (CHECK)
   ================================================== */

ALTER TABLE ANGAJAT
ADD CONSTRAINT CHECK_DATA_ANGAJARII CHECK(DATA_ANGAJARII >= DATA_NASTERII);

ALTER TABLE ANGAJAT
ADD CONSTRAINT CHECK_SALARIU_ANGAJAT CHECK(SALARIU > 0);

ALTER TABLE MATERIALE
ADD CONSTRAINT CHECK_COST_MATERIAL CHECK(COST > 0);

ALTER TABLE ALOCARI_MATERIALE
ADD CONSTRAINT CHECK_CANTITATE_MATERIAL CHECK(CANTITATE > 0);

ALTER TABLE ALOCARE_MUNCITORI
ADD CONSTRAINT CHECK_ORE_LUCRATE CHECK(NR_ORE_LUCRATE > 0);

ALTER TABLE PROIECT
ADD CONSTRAINT CHECK_DATA_PROIECT CHECK(DATA_FINALIZARE IS NULL OR DATA_FINALIZARE >= DATA_INCEPERE);

/* ==================================================
   3. POPULAREA TABELELOR CU DATE
   ================================================== */

-- Clienti
INSERT INTO CLIENT VALUES(1,'Popescu','Ion','Str. Lalelelor 3','Cluj-Napoca','400123','0744123456');
INSERT INTO CLIENT VALUES(2,'Ionescu','Maria','Bd. Eroilor 10','Bucuresti','400321','0723456789');
INSERT INTO CLIENT VALUES(3,'Georgescu','Andrei','Str. Florilor 5','Timisoara','400111','0765432109');
INSERT INTO CLIENT VALUES(4,'Dumitru','Elena','Str. Zambilei 22','Iasi','400222','0756677889');
INSERT INTO CLIENT VALUES(5,'Radu','Stefan','Str. Castanilor 9','Brasov','400333','0777899001');

-- Proiecte
INSERT INTO PROIECT VALUES (101, 1, 'In desfasurare', TO_DATE('2024-05-01','YYYY-MM-DD'), NULL);
INSERT INTO PROIECT VALUES (102, 2, 'Finalizat', TO_DATE('2023-01-10','YYYY-MM-DD'), TO_DATE('2023-10-01','YYYY-MM-DD'));
INSERT INTO PROIECT VALUES (103, 3, 'In desfasurare', TO_DATE('2024-06-15','YYYY-MM-DD'), NULL);
INSERT INTO PROIECT VALUES (104, 4, 'In desfasurare', TO_DATE('2024-04-20','YYYY-MM-DD'), NULL);
INSERT INTO PROIECT VALUES (105, 5, 'Finalizat', TO_DATE('2022-08-01','YYYY-MM-DD'), TO_DATE('2023-02-15','YYYY-MM-DD'));

-- Angajati
INSERT INTO ANGAJAT VALUES (1, 'Stan', 'Daniel', TO_DATE('1990-03-15','YYYY-MM-DD'), TO_DATE('2020-01-01','YYYY-MM-DD'), 5800, 'Zidar', NULL);
INSERT INTO ANGAJAT VALUES (2, 'Toma', 'Marius', TO_DATE('1985-07-22','YYYY-MM-DD'), TO_DATE('2019-05-15','YYYY-MM-DD'), 8000, NULL, 'Structuri metalice');
INSERT INTO ANGAJAT VALUES (3, 'Petrescu', 'Paul', TO_DATE('1992-11-05','YYYY-MM-DD'), TO_DATE('2021-03-10','YYYY-MM-DD'), 6000, 'Electrician', NULL);
INSERT INTO ANGAJAT VALUES (4, 'Barbu', 'Cristina', TO_DATE('1988-02-28','YYYY-MM-DD'), TO_DATE('2022-04-01','YYYY-MM-DD'), 7200, NULL, 'Instalatii');
INSERT INTO ANGAJAT VALUES (5, 'Iacob', 'George', TO_DATE('1995-10-12','YYYY-MM-DD'), TO_DATE('2023-07-01','YYYY-MM-DD'), 5500, 'Dulgher', NULL);

-- Alocare Muncitori
INSERT INTO ALOCARE_MUNCITORI VALUES (111, 101, 1, 160);
INSERT INTO ALOCARE_MUNCITORI VALUES (222, 103, 2, 180);
INSERT INTO ALOCARE_MUNCITORI VALUES (333, 103, 3, 140);
INSERT INTO ALOCARE_MUNCITORI VALUES (444, 104, 1, 40);
INSERT INTO ALOCARE_MUNCITORI VALUES (555, 101, 4, 110);
INSERT INTO ALOCARE_MUNCITORI VALUES (666, 103, 4, 90);
INSERT INTO ALOCARE_MUNCITORI VALUES (777, 104, 3, 70);
INSERT INTO ALOCARE_MUNCITORI VALUES (888, 101, 5, 130);

-- Furnizori
INSERT INTO FURNIZOR VALUES (1, 'MaterialeConstruct', 'Str. Industriei 2', 'Bucuresti', '400123', '0723456789');
INSERT INTO FURNIZOR VALUES (2, 'BetonSRL', 'Str. Padurii 12', 'Iasi', '400321', '0744123456');
INSERT INTO FURNIZOR VALUES (3, 'ElectroMat', 'Str. Industriei 9', 'Bucuresti', '400111', '0760987654');
INSERT INTO FURNIZOR VALUES (4, 'Lemnarul', 'Str. Padurii 3', 'Iasi', '400222', '0784123789');
INSERT INTO FURNIZOR VALUES (5, 'FeroneriePlus', 'Bd. Muncii 13', 'Constanta', '400333', '0733111222');

-- Materiale
INSERT INTO MATERIALE VALUES (1, 1, 'Caramizi', 80);
INSERT INTO MATERIALE VALUES (2, 2, 'Ciment', 110);
INSERT INTO MATERIALE VALUES (3, 2, 'Nisip', 20);
INSERT INTO MATERIALE VALUES (4, 2, 'Pietris', 25);
INSERT INTO MATERIALE VALUES (5, 4, 'Fier beton', 350);

-- Alocari Materiale
INSERT INTO ALOCARE_MATERIALE VALUES (111, 101, 1, 1000);
INSERT INTO ALOCARE_MATERIALE VALUES (222, 101, 2, 500);
INSERT INTO ALOCARE_MATERIALE VALUES (333, 103, 1, 2000);
INSERT INTO ALOCARE_MATERIALE VALUES (444, 104, 3, 800);
INSERT INTO ALOCARE_MATERIALE VALUES (555, 101, 3, 500);
INSERT INTO ALOCARE_MATERIALE VALUES (666, 103, 2, 600);
INSERT INTO ALOCARE_MATERIALE VALUES (777, 104, 4, 700);
INSERT INTO ALOCARE_MATERIALE VALUES (888, 104, 5, 400);

/* ==================================================
   4. MODIFICĂRI DE STRUCTURĂ ȘI CONSTRÂNGERI AVANSATE
   ================================================== */

-- Adăugare coloană email
ALTER TABLE CLIENT ADD EMAIL VARCHAR(50);

-- Modificare lungime nume angajat
ALTER TABLE ANGAJAT MODIFY NUME VARCHAR(40);

-- Constrângere salariu minim
ALTER TABLE ANGAJAT ADD CONSTRAINT SALARIU_MINIM CHECK (SALARIU >= 3000);

-- Constrângere unicitate email
ALTER TABLE CLIENT ADD CONSTRAINT UNIQUE_EMAIL UNIQUE (EMAIL);

/* ==================================================
   5. ACTUALIZĂRI DE DATE (UPDATE)
   ================================================== */

-- Modificare salariu angajat (ID 2)
UPDATE ANGAJAT SET SALARIU=5200 WHERE ID_ANGAJAT=2;

-- Finalizare proiect (ID 103)
UPDATE PROIECT SET STATUS='Finalizat', DATA_FINALIZARE=TO_DATE('2025-05-01','YYYY-MM-DD') WHERE ID_PROIECT=103;

-- Creștere ore lucrate
UPDATE ALOCARE_MUNCITORI SET NR_ORE_LUCRATE=NR_ORE_LUCRATE + 10 WHERE ID_ALOCARE_MUNCITOR=444;

-- Schimbare furnizor material
UPDATE MATERIALE SET ID_FURNIZOR=3 WHERE ID_MATERIAL=5;

/* ==================================================
   6. CREAREA DE VEDERI (VIEWS)
   ================================================== */

-- View: Angajați și proiectele lor
CREATE OR REPLACE VIEW Proiecte_Angajati AS
SELECT ANGAJAT.NUME, ANGAJAT.PRENUME, ANGAJAT.ID_ANGAJAT, ALOCARE_MUNCITORI.ID_PROIECT
FROM ANGAJAT, ALOCARE_MUNCITORI
WHERE ANGAJAT.ID_ANGAJAT = ALOCARE_MUNCITORI.ID_ANGAJAT;

-- View: Detalii materiale și furnizori
CREATE OR REPLACE VIEW Detalii_Materiale AS
SELECT FURNIZOR.DENUMIRE_FIRMA, MATERIALE.DESCRIERE, ALOCARE_MATERIALE.CANTITATE
FROM FURNIZOR, MATERIALE, ALOCARE_MATERIALE
WHERE FURNIZOR.ID_FURNIZOR = MATERIALE.ID_FURNIZOR
AND MATERIALE.ID_MATERIAL = ALOCARE_MATERIALE.ID_MATERIAL;

-- View: Clienți și statusul proiectelor
CREATE OR REPLACE VIEW Clienti_Proiecte AS
SELECT CLIENT.NUME, CLIENT.PRENUME, PROIECT.ID_PROIECT, PROIECT.STATUS
FROM CLIENT, PROIECT
WHERE CLIENT.ID_CLIENT = PROIECT.ID_CLIENT;

-- View: Materiale cu cost ridicat (>300)
CREATE OR REPLACE VIEW Materiale_Scumpe AS
SELECT MATERIALE.ID_MATERIAL, MATERIALE.DESCRIERE, MATERIALE.COST
FROM MATERIALE
WHERE COST>300;